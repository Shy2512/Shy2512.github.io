<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 引入 LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    <script>
      // 初始化（替换为你的 App ID、App Key、服务器地址）
      AV.init({
        appId: "2NKkhrjq5fASWO7uUBEdUmhx-gzGzoHsz",  // 例如："xxx1234567890abcdef"
        appKey: "f0bSP44t9btEynsOfqGZBzvV", // 例如："xxx1234567890abcdef"
        serverURL: "https://2nkkhrjq.lc-cn-n1-shared.com" // 例如："https://abcdef.leancloud.cn"
      });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            padding: 20px;
            background-image: url('https://cdn.luogu.com.cn/upload/image_hosting/lz40zqee.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .main-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(255, 192, 203, 0.3);
            margin-bottom: 20px;
        }

        .username {
            font-size: 2.7em;
            font-weight: 600;
            color: #333;
            margin-right: auto;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            background-color: #1a365d;
            color: white;
            border: none;
            border-radius: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #2c5282;
        }

        .article-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .articles-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            flex: 1;
        }

        .article-title {
            flex: 1;
            padding: 8px 0;
            color: #333;
        }

        .article-action {
            background-color: #1a365d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .article-action:hover {
            background-color: #2c5282;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: auto;
            padding-bottom: 10px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #1a365d;
            background-color: white;
            color: #1a365d;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover, .page-btn.active {
            background-color: #1a365d;
            color: white;
        }

        .ellipsis {
            display: flex;
            align-items: center;
            color: #1a365d;
        }

        /* 新增：退出登录按钮 */
        .logout-btn {
            background-color: #e53e3e;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background-color: #c53030;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 用户信息区（显示当前登录用户名） -->
        <div class="user-info">
            <div class="username" id="username">用户名</div>
            <div class="action-buttons">
                <button class="btn" title="添加"><i class="fas fa-plus"></i></button>
                <button class="btn logout-btn" title="退出登录"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <!-- 文章列表（当前用户的文章） -->
        <div class="articles-list" id="articlesList"></div>

        <!-- 分页按钮 -->
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let currentPage = 1;
        const pageSize = 6;
        let currentUser = ''; // 当前登录用户
        let userArticles = []; // 当前用户的文章数组

        document.addEventListener('DOMContentLoaded', async () => {
            // 检查登录状态（leanCloud方式）
            const currentUser = AV.User.current();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            // 显示用户名
            document.getElementById('username').textContent = currentUser.getUsername();
            // 加载文章（从leanCloud获取）
            await loadUserArticles();
            renderArticles();
            updatePagination();
            showCurrentPageArticles();
            // 退出登录（leanCloud方式）
            document.querySelector('.logout-btn').addEventListener('click', async () => {
                await AV.User.logOut();
                window.location.href = 'login.html';
            });
        });
        //文章加载
        async function loadUserArticles() {
            const user = AV.User.current();
            if (!user) return;
            // 查询当前用户的文章
            const query = new AV.Query('Article');
            query.equalTo('author', user); // 关联当前用户
            query.descending('createdAt'); // 按创建时间倒序
            const articles = await query.find();
            // 转换为本地可用格式
            userArticles = articles.map(article => ({
                id: article.id,
                title: article.get('title'),
                content: article.get('content'),
                createdAt: article.get('createdAt')
            }));
        }
        // 保存当前用户的文章（存储键与用户名绑定，确保数据隔离）
        function saveUserArticles() {
            localStorage.setItem(`articles_${currentUser}`, JSON.stringify(userArticles));
        }

        // 渲染当前用户的文章
        function renderArticles() {
            const articlesList = document.getElementById('articlesList');
            articlesList.innerHTML = '';

            userArticles.forEach(article => {
                const articleItem = document.createElement('div');
                articleItem.className = 'article-item';
                articleItem.dataset.id = article.id;
                // 在home.html的renderArticles函数中，将文章标题改为可点击的链接
                articleItem.innerHTML = `
                    <div class="article-title" style="cursor: pointer;" onclick="window.location.href='article.html?id=${article.id}'">
                        ${article.title}
                    </div>
                    <button class="article-action">删除</button>
                `;
                articlesList.appendChild(articleItem);

                // 绑定删除事件（仅删除当前用户的文章）
                articleItem.querySelector('.article-action').addEventListener('click', async function() {
                    if (confirm('确定删除？')) {
                        const articleId = this.parentElement.dataset.id;
                        // 调用leanCloud删除接口
                        const article = AV.Object.createWithoutData('Article', articleId);
                        await article.destroy();
                        // 重新加载列表
                        await loadUserArticles();
                        renderArticles();
                        updatePagination();
                        showCurrentPageArticles();
                    }
                });
            });
        }

        // 计算当前用户的文章总页数
        function getTotalPages() {
            return Math.max(1, Math.ceil(userArticles.length / pageSize));
        }

        // 更新分页控件
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = getTotalPages();

            if (currentPage > totalPages) {
                currentPage = totalPages;
            }

            if (totalPages <= 5) {
                for (let i = 1; i <= totalPages; i++) {
                    addPageButton(i);
                }
            } else {
                for (let i = 1; i <= 3; i++) {
                    addPageButton(i);
                }
                const ellipsis = document.createElement('div');
                ellipsis.className = 'ellipsis';
                ellipsis.textContent = '...';
                pagination.appendChild(ellipsis);
                addPageButton(totalPages);
            }
        }

        // 添加分页按钮
        function addPageButton(pageNum) {
            const btn = document.createElement('button');
            btn.className = `page-btn ${pageNum === currentPage ? 'active' : ''}`;
            btn.textContent = pageNum;
            btn.addEventListener('click', () => {
                currentPage = pageNum;
                updatePagination();
                showCurrentPageArticles();
            });
            document.getElementById('pagination').appendChild(btn);
        }

        // 显示当前页的文章
        function showCurrentPageArticles() {
            const articles = document.querySelectorAll('.article-item');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize - 1;

            articles.forEach((article, index) => {
                article.style.display = (index >= startIndex && index <= endIndex) ? 'flex' : 'none';
            });
        }

        // 替换home.html中添加文章的代码
        document.querySelector('.action-buttons .fa-plus').parentElement.addEventListener('click', () => {
            // 跳转到编辑页
            window.location.href = 'editor.html';
        });
    </script>
</body>
</html>
